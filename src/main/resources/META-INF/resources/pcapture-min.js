var keycloak=null,timer=null,autoRefresh=null;function logout(){keycloak.logout()}function generateTableHead(e,t){let o=e.createTHead().insertRow();if(!t[0])return;for(let e of Object.keys(t[0])){let t=document.createElement("th"),n=document.createTextNode(e);t.appendChild(n),o.appendChild(t)}let n=document.createElement("th");n.setAttribute("colspan","3");let a=document.createTextNode("Controls");n.appendChild(a),o.appendChild(n)}function generateTable(e,t){for(let o of t){let t=e.insertRow(),n=null;for(key in o){let e=t.insertCell();if("creationTime"===key||"lastModifiedTime"==key){let t=new Date(o[key]);let n=document.createTextNode(t.toLocaleDateString()+" "+t.toLocaleTimeString());e.appendChild(n)}else if("length"===key){let t=document.createElement("div"),n=document.createTextNode(o[key]);t.appendChild(n),e.appendChild(t)}else if("status"===key){n=o[key];let t=document.createTextNode(o[key]);e.appendChild(t)}else{let t=document.createTextNode(o[key]);e.appendChild(t)}}let a=o.id,r=t.insertCell(),l=document.createElement("button");l.setAttribute("type","button"),l.innerHTML="Download",l.setAttribute("onclick","downloadCapture('"+a+"')"),r.appendChild(l);let c=t.insertCell(),i=document.createElement("button");i.setAttribute("type","button"),i.innerHTML="Stop",i.setAttribute("onclick","stopCapture('"+a+"')"),c.appendChild(i),i.disabled="running"!==n;let s=t.insertCell(),d=document.createElement("button");d.setAttribute("type","button"),d.innerHTML="Delete",d.setAttribute("onclick","deleteCapture('"+a+"')"),s.appendChild(d),d.disabled="running"===n}}function generateStartButtons(){axios({method:"get",url:"/api/filter",headers:{Authorization:"Bearer "+keycloak.token}}).then(e=>{var t=document.getElementById("startButtonsParent");e.data.forEach(e=>{var o=e.urlSuffix,n=e.label,a=document.createElement("button");a.innerHTML=n,a.setAttribute("onclick","startCapture('"+o+"')"),t.appendChild(a)})}).except(e=>console.log(e))}function toggleAllUsers(){axios({method:"put",url:"/api/user/toggleAllUsers",headers:{Authorization:"Bearer "+keycloak.token}}).then(e=>{console.log("All Users preference toggled for user",keycloak.idTokenParsed.preferred_username)}).catch(e=>{console.log(e)})}function refreshClick(){var e=document.getElementById("refreshCheckbox"),t=document.getElementById("refreshButton");1==e.checked?(timer=setInterval(()=>listCaptures(),2e3),autoRefresh=!0,t.hidden=!0):(clearInterval(timer),autoRefresh=!1,t.hidden=!1)}function updateAllUsersButton(){axios({method:"get",url:"/api/user/isAdmin",headers:{Authorization:"Bearer "+keycloak.token}}).then(e=>{document.getElementById("allUsersButton").hidden=!e.data}).catch(e=>{console.log(e)})}function listCaptures(){axios({method:"get",url:"/api/capture",headers:{Authorization:"Bearer "+keycloak.token}}).then(e=>{const t=document.querySelector("table");t.innerHTML="",generateTableHead(t,e.data),generateTable(t,e.data)}).catch(e=>{e.response?(console.log("Refreshing authorization token"),keycloak.updateToken(5).then(()=>{console.log("Token refreshed")}).catch(()=>{console.log("Failed to refresh authorization token, reloading window."),window.location.reload()})):e.request?console.log("No response received ",e.request):console.log("Other error",e)})}function startCapture(e){axios({method:"post",url:"/api/capture/"+e,headers:{Authorization:"Bearer "+keycloak.token}}).then(e=>{console.log("Start",e.config.method,e.config.url,e.data),0==autoRefresh&&listCaptures()}).catch(e=>console.log(e))}function stopCapture(e){axios({method:"put",url:"/api/capture/"+e,headers:{Authorization:"Bearer "+keycloak.token}}).then(e=>{console.log("Stop",e.config.method,e.config.url),0==autoRefresh&&listCaptures()}).catch(e=>console.log(e))}function downloadCapture(e){axios({method:"get",url:"/api/capture/"+e,headers:{Authorization:"Bearer "+keycloak.token,Accept:"application/octet-stream"},responseType:"blob"}).then(e=>{const t=window.URL.createObjectURL(new Blob([e.data])),o=document.createElement("a");o.href=t,o.setAttribute("download","capture.pcapng"),document.body.appendChild(o),o.click(),console.log("Download",e.config.method,e.config.url)}).catch(e=>console.log(e))}function deleteCapture(e){axios({method:"delete",url:"/api/capture/"+e,headers:{Authorization:"Bearer "+keycloak.token}}).then(e=>{console.log("Delete",e.config.method,e.config.url),0==autoRefresh&&listCaptures()}).catch(e=>console.log(e))}fetch("/api/res/configjson").then(e=>e.json()).then(e=>{var t=e["auth-server-url"],o=document.createElement("script");o.onload=(()=>{(keycloak=new Keycloak("/api/res/configjson")).init({onLoad:"login-required"}).then(()=>{let e=keycloak.idTokenParsed.preferred_username;console.log("User "+e+" is now authenticated."),document.getElementById("username").innerHTML="Logged in as: "+e,updateAllUsersButton(),timer=setInterval(()=>listCaptures(),2e3),autoRefresh=!0,generateStartButtons()}).catch(()=>{}),keycloak.updateToken(30).then(e=>{e&&console.log("Token refreshed")}).catch(()=>{console.log("Failed to refresh token, or the session has expired.")})}),o.src=t+"/js/keycloak.js",document.head.appendChild(o)}).catch(e=>console.log(e));