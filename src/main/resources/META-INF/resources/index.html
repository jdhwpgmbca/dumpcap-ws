<html>
<head>
    <title>keycloak-spa</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="${auth.server.url}/auth/js/keycloak.js"></script>
    <style>
        table, th, td {
            border: 1px solid black;
            padding: 5px;
        }
    </style>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
    <script>
        var keycloak = new Keycloak();
        keycloak.init({onLoad: 'login-required'}).then(function () {
            console.log('User is now authenticated.');
            listCaptures();
        }).catch(function () {
            window.location.reload();
        });
        function logout() {
            keycloak.logout();
        }
        setInterval( () => {
            listCaptures();
        }, 2000 );
        function generateTableHead(table, data) {
            let thead = table.createTHead();
            let row = thead.insertRow();
            for (let key of Object.keys(data[0])) {

                let th = document.createElement('th');
                let text = document.createTextNode(key);
                th.appendChild(text);
                row.appendChild(th);
            }
        }
        function generateTable(table, data) {
            for (let element of data) {
                let row = table.insertRow();
                for (key in element) {
                    let cell = row.insertCell();
                    if (key == 'length') {
                        let div = document.createElement('div');
                        let text = document.createTextNode(element[key]);
                        div.appendChild(text);
                        cell.appendChild(div);
                    } else {
                        let text = document.createTextNode(element[key]);
                        cell.appendChild(text);
                    }
                }

                let id = element['id'];

                let downloadCell = row.insertCell();
                let downloadBtn = document.createElement('button');
                downloadBtn.setAttribute("type", "button") ;
                downloadBtn.innerHTML = "Download";
                downloadBtn.setAttribute( "onclick", "downloadCapture('" + id + "')"); 
                downloadCell.appendChild(downloadBtn);

                let stopCell = row.insertCell();
                let stopBtn = document.createElement('button');
                stopBtn.setAttribute('type','button');
                stopBtn.innerHTML = "Stop";
                stopBtn.setAttribute( "onclick", "stopCapture('" + id + "')"); 
                stopCell.appendChild(stopBtn);

                let deleteCell = row.insertCell();
                let deleteBtn = document.createElement('button');
                deleteBtn.setAttribute('type','button');
                deleteBtn.innerHTML = "Delete";
                deleteBtn.setAttribute('onclick',"deleteCapture('" + id + "')");
                deleteCell.appendChild(deleteBtn);
            }
        }
        function listCaptures() {
            axios({
                method: 'get',
                url: '/api/capture',
                headers: {
                    'Authorization': 'Bearer ' + keycloak.token
                }
            })
            .then( response => {
                const mytable = document.querySelector('table');
                mytable.innerHTML = '';
                generateTableHead(mytable,response.data);
                generateTable(mytable,response.data);
            })
            .catch( error => {
                console.log('refreshing');
                keycloak.updateToken(5).then( () => {
                    console.log('Token refreshed');
                }).catch( () => {
                    console.log('Failed to refresh token');
                    window.location.reload();
                });
            });
    }
    function startCapture() {
        axios({
            method: 'post',
            url: '/api/capture',
            headers: {
                'Authorization': 'Bearer ' + keycloak.token
            }
        })
        .then( response => {
            console.log( "New capture started!", response );
            listCaptures();
        })
        .catch( (error) => console.log( error ) );
    }
    function stopCapture(id) {
        axios({
            method: 'put',
            url: "/api/capture/" + id,
            headers: {
                'Authorization': 'Bearer ' + keycloak.token
            }
        })
        .then( response => {

            console.log('Stopped!');
            listCaptures();
            // window.location.reload();

        })
        .catch( (error) => console.log(error) )
    }
    function downloadCapture(id) {
        axios({
            method: 'get',
            url: '/api/capture/' + id,
            headers: {
                'Authorization': 'Bearer ' + keycloak.token,
                'Accept': 'application/octet-stream'
            },
            responseType: 'blob'
        })
        .then( response => {

            const url = window.URL.createObjectURL(new Blob([response.data]));
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download','capture.pcapng');
            document.body.appendChild(link);
            link.click();

        })
        .catch( error => console.log( error ) );
    }
    function deleteCapture(id) {
        axios({
            method: 'delete',
            url: '/api/capture/' + id,
            headers: {
                'Authorization': 'Bearer ' + keycloak.token
            }
        })
        .then( response => {

            console.log('Deleted!');
            listCaptures();

        })
        .catch( error => console.log(error) )
    }
    </script>
</head>
<body>
    <button onclick="listCaptures()">List Captures</button>
    <button onclick="startCapture()">Start Capture</button>
    <button onclick="logout()">Logout</button>
    <table id="mytable" style="padding: 1em;">

    </table>
</body>
</html>