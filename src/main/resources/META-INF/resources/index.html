<html>
<head>
    <title>keycloak-spa</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!--<script src="${auth.server.url}/auth/js/keycloak.js"></script>-->
    <script src="https://keycloak.rtds.com/auth/js/keycloak.js"></script>
    <style>
        table, th, td {
            padding: 5px;
        }
        tr:nth-child(even) { background-color: #f2f2f2; }
    </style>
    <script>
        var keycloak = new Keycloak();
        keycloak.init({onLoad: 'login-required'}).then(function () {
            let username = keycloak.idTokenParsed.preferred_username;
            console.log('User ' + username + ' is now authenticated.');
            let usernameDiv = document.getElementById('username');
            usernameDiv.innerHTML = 'Logged in as: ' + username;
            updateAllUsersButton();
            setInterval( () => {
                listCaptures();
            }, 2000 );
        }).catch(function () {
            window.location.reload();
        });
        function logout() {
            keycloak.logout();
        }
        function generateTableHead(table, data) {
            let thead = table.createTHead();
            let row = thead.insertRow();
            if (!data[0]) return;
            for (let key of Object.keys(data[0])) {

                let th = document.createElement('th');
                let text = document.createTextNode(key);
                th.appendChild(text);
                row.appendChild(th);
            }
            let th = document.createElement('th');
            th.setAttribute('colspan',"3");
            let text = document.createTextNode('Controls');
            th.appendChild(text);
            row.appendChild(th);
        }
        function generateTable(table, data) {
            for (let element of data) {
                let row = table.insertRow();
                let status = null;
                for (key in element) {
                    let cell = row.insertCell();
                    if (key === 'creationTime' || key == 'lastModifiedTime') {
                        let date = new Date(element[key]);
                        var options = { weekday: undefined, year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric' };
                        let text = document.createTextNode( date.toLocaleDateString() + ' ' + date.toLocaleTimeString() );
                        cell.appendChild(text);
                    } else if (key === 'length') {
                        let div = document.createElement('div');
                        let text = document.createTextNode(element[key]);
                        div.appendChild(text);
                        cell.appendChild(div);
                    } else if (key === 'status') {
                        status = element[key];
                        let text = document.createTextNode(element[key]);
                        cell.appendChild(text);
                    } else {
                        let text = document.createTextNode(element[key]);
                        cell.appendChild(text);
                    }
                }

                let id = element['id'];

                let downloadCell = row.insertCell();
                let downloadBtn = document.createElement('button');
                downloadBtn.setAttribute("type", "button") ;
                downloadBtn.innerHTML = "Download";
                downloadBtn.setAttribute( "onclick", "downloadCapture('" + id + "')"); 
                downloadCell.appendChild(downloadBtn);

                let stopCell = row.insertCell();
                let stopBtn = document.createElement('button');
                stopBtn.setAttribute('type','button');
                stopBtn.innerHTML = "Stop";
                stopBtn.setAttribute( "onclick", "stopCapture('" + id + "')"); 
                stopCell.appendChild(stopBtn);

                if (status === 'running') {
                    stopBtn.disabled = false;
                } else {
                    stopBtn.disabled = true;
                }

                let deleteCell = row.insertCell();
                let deleteBtn = document.createElement('button');
                deleteBtn.setAttribute('type','button');
                deleteBtn.innerHTML = "Delete";
                deleteBtn.setAttribute('onclick',"deleteCapture('" + id + "')");
                deleteCell.appendChild(deleteBtn);

                if (status === 'running') {
                    deleteBtn.disabled = true;
                } else {
                    deleteBtn.disabled = false;
                }
            }
        }
        function toggleAllUsers() {
            axios({
                method: 'put',
                url: '/api/user/toggleAllUsers',
                headers: {
                    'Authorization': 'Bearer ' + keycloak.token
                }
            })
            .then( response => {
                console.log('All Users preference toggled for user', keycloak.idTokenParsed.preferred_username );
            } )
            .catch( error => {
                console.log( error );
            } );
        }
        function updateAllUsersButton() {
            axios({
                method: 'get',
                url: '/api/user/isAdmin',
                headers: {
                    'Authorization': 'Bearer ' + keycloak.token
                }
            })
            .then( response => {
                let allUsersButton = document.getElementById('allUsersButton');
                allUsersButton.hidden = !response.data;
            } )
            .catch( error => {
                console.log( error );
            } );
        }
        function listCaptures() {
            axios({
                method: 'get',
                url: '/api/capture',
                headers: {
                    'Authorization': 'Bearer ' + keycloak.token
                }
            })
            .then( response => {
                const mytable = document.querySelector('table');
                mytable.innerHTML = '';
                generateTableHead(mytable,response.data);
                generateTable(mytable,response.data);
            })
            .catch( error => {
                if (error.response) {
                    console.log('Refreshing authorization token');
                    keycloak.updateToken(5).then( () => {
                        console.log('Token refreshed');
                    }).catch( () => {
                        console.log('Failed to refresh authorization token, reloading window.');
                        window.location.reload();
                    });
                } else if (error.request) {
                    console.log('No response received ', error.request);
                } else {
                    console.log('Other error', error);
                }
            });
    }
    function startCapture(type) {
        axios({
            method: 'post',
            url: '/api/capture/' + type,
            headers: {
                'Authorization': 'Bearer ' + keycloak.token
            }
        })
        .then( response => {
            console.log("Start", response.config.method, response.config.url, response.data);
        })
        .catch( error => console.log( error ) );
    }
    function stopCapture(id) {
        axios({
            method: 'put',
            url: "/api/capture/" + id,
            headers: {
                'Authorization': 'Bearer ' + keycloak.token
            }
        })
        .then( response => {
            console.log('Stop', response.config.method, response.config.url);
        })
        .catch( error => console.log(error) )
    }
    function downloadCapture(id) {
        axios({
            method: 'get',
            url: '/api/capture/' + id,
            headers: {
                'Authorization': 'Bearer ' + keycloak.token,
                'Accept': 'application/octet-stream'
            },
            responseType: 'blob'
        })
        .then( response => {
            const url = window.URL.createObjectURL(new Blob([response.data]));
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download','capture.pcapng');
            document.body.appendChild(link);
            link.click();
            console.log('Download', response.config.method, response.config.url);
        })
        .catch( error => console.log( error ) );
    }
    function deleteCapture(id) {
        axios({
            method: 'delete',
            url: '/api/capture/' + id,
            headers: {
                'Authorization': 'Bearer ' + keycloak.token
            }
        })
        .then( response => {
            console.log('Delete', response.config.method, response.config.url);
            listCaptures();
        })
        .catch( error => console.log(error) )
    }
    </script>
</head>
<body>
    <button onclick="startCapture('all')">Start Generic Capture</button>
    <button onclick="startCapture('goose')">Start Goose Capture</button>
    <button onclick="startCapture('gse')">Start GSE Capture</button>
    <button onclick="startCapture('sv')">Start SV Capture</button>
    <button id="allUsersButton" onclick="toggleAllUsers()">Toggle All Users</button>
    <button onclick="logout()">Logout</button>
    <div id="username"></div>
    <table id="mytable" style="padding: 1em;">

    </table>
</body>
</html>